<!--
Copyright 2022 Matthias MÃ¼ller - Ten Minute Physics, 
www.youtube.com/c/TenMinutePhysics
www.matthiasMueller.info/tenMinutePhysics

MIT License

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->
<!DOCTYPE html>
<html>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <head>
        <title>Euler Fluid</title>
        <style>
			body {
				font-family: verdana; 
				font-size: 15px;
			}			
			.button {
				background-color: #606060;
				border: none;
				color: white;
				padding: 10px 10px;
				font-size: 16px;
				margin: 4px 2px;
				cursor: pointer;
			}
			.slider {
				-webkit-appearance: none;
				width: 80px;
				height: 6px;
				border-radius: 5px;
				background: #d3d3d3;
				outline: none;
				opacity: 0.7;
				-webkit-transition: .2s;
				transition: opacity .2s;
			}
        </style>
    </head>
    <body>
        <button class="button" onclick="setupScene(1)">Wind Tunnel</button>
        <button class="button" onclick="setupScene(3)">Hires Tunnel</button>
        <button class="button" onclick="setupScene(0)">Tank</button>
        <button class="button" onclick="setupScene(2)">Paint</button>
        <input type="checkbox" id="streamButton" onclick="scene.showStreamlines = !scene.showStreamlines">
        Streamlines
        <input type="checkbox" id="velocityButton" onclick="scene.showVelocities = !scene.showVelocities">
        Velocities
        <input
            type="checkbox"
            name="field"
            id="pressureButton"
            onclick="scene.showPressure = !scene.showPressure;"
        >
        Pressure
        <input
            type="checkbox"
            name="field"
            id="smokeButton"
            onclick="scene.showSmoke = !scene.showSmoke;"
            checked
        >
        Smoke
        <input
            type="checkbox"
            id="overrelaxButton"
            onclick="scene.overRelaxation = scene.overRelaxation == 1.0 ? 1.9 : 1.0"
            checked
        >
        Overrelax
        <br>
        <canvas id="myCanvas" style="border:2px solid"></canvas>
        <script>

let squaretable = {} //lets assume I can store this in a script as a variable
for (let t = 0; t < 10000000; t++) {
    squaretable[`${t}`] = Math.sqrt(t)
    if (t > 999) {
        t += 9
    }
}
	var canvas = document.getElementById("myCanvas");
	var c = canvas.getContext("2d", {willReadFrequently : true});	
	canvas.width = 640
	canvas.height = 360

	canvas.focus();
    let video_recorder
    let recording = 0

    function angleGrasp(x, y) {
        // let vec = new Vector(globalVecPoint, x, y)
        // vec.normalize(1)
        ////console.log(vec)
        // anglemegacount++
        ////console.log(`${Math.floor(vec.xmom*10000)*.0001},${Math.floor(vec.ymom*10000)*.0001}`)
        return Math.atan2(x, y) //angletable[`${Number.parseFloat(Math.floor(vec.xmom*10000)*.0001).toPrecision(4)},${Number.parseFloat(Math.floor(vec.ymom*10000)*.0001).toPrecision(4)}`]
    }

    class LineOP {
        constructor(object, target, color, width) {
            this.object = object
            this.target = target
            this.color = color
            this.width = width
        }
        angle() {
            return angleGrasp(this.object.y - this.target.y, this.object.x - this.target.x)
        }
        m_angle() {
            return Math.atan2(this.object.y - this.target.y, this.object.x - this.target.x)
        }
        hypotenuse() {
            let xdif = this.object.x - this.target.x
            let ydif = this.object.y - this.target.y
            let hypotenuse = (xdif * xdif) + (ydif * ydif)
            if (hypotenuse < 10000000 - 1) {
                if (hypotenuse > 1000) {
                    return squaretable[`${Math.round(10 * Math.round((hypotenuse * .1)))}`]
                } else {
                    return squaretable[`${Math.round(hypotenuse)}`]
                }
            } else {
                return Math.sqrt(hypotenuse)
            }
        }
        m_hypotenuse() {
            let xdif = this.object.x - this.target.x
            let ydif = this.object.y - this.target.y
            let hypotenuse = (xdif * xdif) + (ydif * ydif)
            return Math.sqrt(hypotenuse)
        }
        squareDistance() {
            let xdif = this.object.x - this.target.x
            let ydif = this.object.y - this.target.y
            let hypotenuse = (xdif * xdif) + (ydif * ydif)
            return (hypotenuse)
        }
        draw() {
            let linewidthstorage = tutorial_canvas_context.lineWidth
            tutorial_canvas_context.strokeStyle = this.color
            tutorial_canvas_context.lineWidth = this.width
            tutorial_canvas_context.beginPath()
            tutorial_canvas_context.moveTo(this.object.x, this.object.y)
            tutorial_canvas_context.lineTo(this.target.x, this.target.y)
            tutorial_canvas_context.stroke()
            tutorial_canvas_context.lineWidth = linewidthstorage
            tutorial_canvas_context.closePath();
        }
    }
    class Circlec {
        constructor(x, y, radius, color, xmom = 0, ymom = 0) {

            this.height = 0
            this.width = 0
            this.x = x
            this.y = y
            this.radius = radius
            this.color = color
            this.xmom = xmom
            this.ymom = ymom
            this.xrepel = 0
            this.yrepel = 0
            this.lens = 0
        }
        draw() {
            tutorial_canvas_context.fillStyle = this.color

            if (!ramps.includes(this)) {
                tutorial_canvas_context.fillStyle = this.color
            } else {
                tutorial_canvas_context.fillStyle = this.color
            }
            tutorial_canvas_context.lineWidth = 4
            tutorial_canvas_context.strokeStyle = this.color
            tutorial_canvas_context.beginPath();
            tutorial_canvas_context.arc(this.x, this.y, this.radius, 0, (Math.PI * 2), true)

            tutorial_canvas_context.fill()
            tutorial_canvas_context.stroke();
            tutorial_canvas_context.closePath();
        }
        move() {
            this.x += this.xmom
            this.y += this.ymom
            if (this == pomao.body) {
                tutorial_canvas_context.translate(-this.xmom, -this.ymom)
            }
        }
        isPointInside(point) {
            this.areaY = point.y - this.y
            this.areaX = point.x - this.x
            if (((this.areaX * this.areaX) + (this.areaY * this.areaY)) <= (this.radius * this.radius)) {
                return true
            }
            return false
        }

        repelCheck(point) {
            this.areaY = point.y - this.y
            this.areaX = point.x - this.x
            if (((this.areaX * this.areaX) + (this.areaY * this.areaY)) <= (this.radius + point.radius) * (point.radius + this.radius)) {
                return true
            }
            return false
        }
    }
    class Circlex {
        constructor(x, y, radius, color, xmom = 0, ymom = 0) {

            this.height = 0
            this.width = 0
            this.x = x
            this.y = y
            this.radius = radius
            this.color = color
            this.xmom = xmom
            this.ymom = ymom
            this.sxmom = 0
            this.symom = 0
            this.wxmom = 0
            this.wymom = 0
            this.xrepel = 0
            this.yrepel = 0
            this.lens = 0
        }
        steer() {

        }
        steery() {

        }
        draw() {
            let dummy = new Circlec(this.x, this.y, this.radius, this.color)
            dummy.draw()
        }
        move() {
            // if(cheats.warpspeed == 1){
            //     for(let t = 0;t<3;t++){
            //         this.x += this.xmom
            //         this.y += this.ymom
            //         if (this == pomao.body) {
            //             for (let t = 1; t < pomao.eggs.length; t++) {
            //                 //     for(let k = 0; pomao.eggs[t].pos.length; k++){
            //                 if (Math.abs(this.sxmom) > 0) {
            //                     pomao.eggs[t].steer()
            //                 } else if (Math.abs(this.xmom) > 0) {
            //                     pomao.eggs[t].steer()
            //                 }
            //                 //          break
            //                 //         // ////////////console.log(pomao.eggs[t].pos)
            //                 //     }
            //             }
            //             tutorial_canvas_context.translate(-this.xmom, -this.ymom)
            //         }
            //         this.smove()}
            // }

            this.x += this.xmom
            this.y += this.ymom



            if (this == pomao.body) {
                for (let t = 1; t < pomao.eggs.length; t++) {
                    //     for(let k = 0; pomao.eggs[t].pos.length; k++){
                    if (Math.abs(this.sxmom) > 0) {
                        pomao.eggs[t].steer()
                    } else if (Math.abs(this.xmom) > 0) {
                        pomao.eggs[t].steer()
                    }
                    //          break
                    //         // ////////////console.log(pomao.eggs[t].pos)
                    //     }
                }
                tutorial_canvas_context.translate(-this.xmom, -this.ymom)
            }
            this.smove()
        }
        ymove() {
            // this.x += this.xmom
            this.y += this.ymom
            if (this == pomao.body) {
                tutorial_canvas_context.translate(0, -this.ymom)
            }

            // forgot symom, hopfully adding it won't break this // broke it, ok trying something else

            if (this.ymom + this.symom > 0) {
                // this seems more normal and still balanced better than always adding it
                this.y += this.symom
                if (this == pomao.body) {
                    tutorial_canvas_context.translate(0, -this.symom)
                }
            } else {
                let blocktongue = 0
                for (let t = 0; t < floors.length; t++) {
                    if (floors[t].isPointInside(pomao.tongue) | !pomao.tonguebox.isInsideOf(floors[t])) {
                        blocktongue = 1
                    }
                }
                if (blocktongue == 1) {
                    pomao.tonguex *= .975
                    pomao.tonguey *= .975
                }
            }

        }
        wmove() {
            this.x += this.wxmom

            if (Math.abs(this.wymom) <= 3.1) {
                this.y += this.wymom
                if (this == pomao.body) {
                    tutorial_canvas_context.translate(-this.wxmom, -this.wymom)
                }
            } else {

                this.y += this.wymom
                if (this == pomao.body) {
                    tutorial_canvas_context.translate(-this.wxmom, -this.wymom)
                }
                // this.y += (this.symom/(Math.abs(this.symom)))*3.1
                // if (this == pomao.body) {
                //     tutorial_canvas_context.translate(-this.sxmom, -(this.symom/(Math.abs(this.symom)))*3.1)
                // }
            }

            pomao.body.wxmom *= .95
            pomao.body.wymom *= .95
        }
        wmovecut() {
            this.x += this.wxmom

            this.y += this.wymom
            if (this == pomao.body) {
                tutorial_canvas_context.translate(-this.wxmom, -this.wymom)
            }
            pomao.body.wxmom = 0
            pomao.body.wymom = 0
        }
        smove() {
            this.wmove()
            // this.x += this.sxmom
            if (this.symom != 0) {
                if (Math.abs(this.symom) <= 3.1) {
                    this.y += this.symom
                    if (this == pomao.body) {
                        tutorial_canvas_context.translate(0, -this.symom)
                    }
                } else {

                    this.y += this.symom
                    if (this == pomao.body) {
                        tutorial_canvas_context.translate(0, -this.symom)
                    }
                    //     this.y += 3.1 * (Math.abs(this.symom)/this.symom)
                    //     if (this == pomao.body) {
                    //         tutorial_canvas_context.translate(0, -3.1 * (Math.abs(this.symom)/this.symom))
                    //     }
                }
            }
            if (this.sxmom != 0) {
                if (Math.abs(this.sxmom) <= 3.1) {
                    this.x += 3.1 * (Math.abs(this.sxmom) / this.sxmom)
                    if (this == pomao.body) {
                        tutorial_canvas_context.translate(-3.1 * (Math.abs(this.sxmom) / this.sxmom), 0)
                    }
                } else {

                    this.x += this.sxmom
                    if (this == pomao.body) {
                        tutorial_canvas_context.translate(-this.sxmom, 0)
                    }
                }
            }

            for (let t = 0; t < blocks.length; t++) {
                if (squarecirclefaceblockjump(blocks[t], pomao.body)) {

                    blocks[t].ymom = this.ymom + this.symom
                    // if(!blocks[t].isBlocked){
                    blocks[t].xmom = this.sxmom + this.xmom
                    // }
                }
            }

            // if (this == pomao.body) {
            //     tutorial_canvas_context.translate(-this.sxmom, -this.symom)
            // }
        }
        isPointInside(point) {
            this.areaY = point.y - this.y
            this.areaX = point.x - this.x
            if (((this.areaX * this.areaX) + (this.areaY * this.areaY)) <= (this.radius * this.radius)) {
                return true
            }
            return false
        }

        repelCheck(point) {
            this.areaY = point.y - this.y
            this.areaX = point.x - this.x
            if (((this.areaX * this.areaX) + (this.areaY * this.areaY)) <= (this.radius + point.radius) * (point.radius + this.radius)) {
                return true
            }
            return false
        }
    }

    class Shape {
        constructor(shapes) {
            this.shapes = shapes
        }
        adjustByFromDisplacement(x, y) {
            for (let t = 0; t < this.shapes.length; t++) {
                if (typeof this.shapes[t].fromRatio == "number") {
                    this.shapes[t].x += x * this.shapes[t].fromRatio
                    this.shapes[t].y += y * this.shapes[t].fromRatio
                }
            }
        }
        adjustByToDisplacement(x, y) {
            for (let t = 0; t < this.shapes.length; t++) {
                if (typeof this.shapes[t].toRatio == "number") {
                    this.shapes[t].x += x * this.shapes[t].toRatio
                    this.shapes[t].y += y * this.shapes[t].toRatio
                }
            }
        }
        arcXInc(val) {
            for (let t = 0; t < this.shapes.length; t++) {
                this.shapes[t].x += val * this.shapes[t].fromrat
            }
        }
        arcYInc(val) {
            for (let t = 0; t < this.shapes.length; t++) {
                this.shapes[t].y += val * this.shapes[t].fromrat
            }
        }
        breakin(arr) {
            for (let t = 0; t < arr.length; t++) {
                for (let k = 0; k < arr[t].shapes.length; k++) {
                    this.shapes.push(arr[t].shapes[k])
                }
            }
        }
        invarcXInc(val) {
            for (let t = 0; t < this.shapes.length; t++) {
                this.shapes[t].x += val * this.shapes[t].torat
            }
        }
        invarcYInc(val) {
            for (let t = 0; t < this.shapes.length; t++) {
                this.shapes[t].y += val * this.shapes[t].torat
            }
        }
        isPointInsideTargetedSnow(point) {
            let cold = 0
            let pointer = new Bosscircle(0, 0, 0, "red")
            pointer.angle = 0
            let pointerbig = new Bosscircle(0, 0, 0, "red")
            let count = 0
            let smackcold = 0
            let angles = []
            let sto = {}
            for (let t = 0; t < this.shapes.length; t++) {
                if (this.shapes[t].repelCheck(point)) {
                    if (count == 0) {
                        sto = this.shapes[t]
                    }
                    angles.push(Math.round(this.shapes[t].angle * 100) / 100)
                    pointer.angle += (Math.round(this.shapes[t].angle * 100) / 100)
                    pointer.x += this.shapes[t].x
                    pointer.y += this.shapes[t].y
                    if (this.shapes[t].radius == 140) { //defunct
                        pointerbig.x = this.shapes[t].x
                        pointerbig.y = this.shapes[t].y
                        count = 1
                        cold = 2
                        smackcold = 1
                        pointerbig.radius = this.shapes[t].radius
                        // break
                    } else if (this.shapes[t].radius > pointer.radius && pointer.radius != 0) {
                        pointerbig.x = this.shapes[t].x
                        pointerbig.y = this.shapes[t].y
                        count = 1
                        cold = 2
                        smackcold = 1
                        pointerbig.radius = this.shapes[t].radius
                        // break
                    } else {
                        count++
                        cold = 1
                        pointer.radius = this.shapes[t].radius
                    }
                }
            }
            if (smackcold == 1) {
                cold = 2
            }
            // if(count > 1){
            //     pointer.x += -300
            //     pointer.y += -700
            // }

            pointer.x /= (count + 0)
            pointer.y /= (count + 0)
            pointer.angle /= count
            pointer.angle = (Math.round(pointer.angle * 100) / 100)
            // //////console.log(angles)
            if (cold == 0) {
                if (angles.includes(pointer.angle)) {

                } else if (angles.length > 0) {
                    // //////console.log(angles, pointer.angle)
                    sto.color = "green"
                    // sto.draw()
                    sto.marked = true
                    return sto
                }
                return false
            } else if (cold == 1) {
                if (angles.includes(pointer.angle)) {

                } else if (angles.length > 0) {
                    // //////console.log(angles, pointer.angle)
                    pointer.radius *= .2
                    sto.color = "#00ff00"
                    // pointer.draw()
                    sto.marked = true
                    return pointer
                }
                // pointer.draw()
                if (pomao.body.y - (pomao.body.radius * .5) > pointer.y) {
                    pointer.color = "blue"
                    // pointer.draw()
                    pointer.marked = false
                    return pointer
                    // pointer.radius *= 1.05
                }
                pointer.marked = true
                return pointer
            } else {

                if (angles.includes(pointer.angle)) {

                } else if (angles.length > 0) {
                    sto.color = "green"
                    // sto.draw()
                    sto.marked = true
                    return sto
                }
                // pointerbig.draw()
                if (pomao.body.y - (pomao.body.radius * .5) > pointerbig.y) {
                    pointerbig.color = "blue"
                    // pointerbig.draw()
                    pointerbig.marked = false
                    return pointerbig
                    // pointer.radius *= 1.05
                }
                pointerbig.marked = true
                return pointerbig
            }

        }
        snowFloorShapeTest(point) {

            let retvar = 0
            let arrayhold = []
            let click = 0
            for (let t = 0; t < this.shapes.length; t++) {
                if (squarecircleedges(this.shapes[t], point)) {
                    arrayhold.push(this.shapes[t].y)
                    click = 1
                }
            }
            if (arrayhold.length > 0) {
                retvar = arrayhold.reduce((accum, curr) => accum + curr) / arrayhold.length
            }

            if (click > 0) {
                return retvar
            }

            return false


        }
        isPointInside(point) {
            for (let t = 0; t < this.shapes.length; t++) {
                if (this.shapes[t].repelCheck(point)) {
                    return true
                }
            }

            return false
        }
        repelCheck(point) {
            for (let t = 0; t < this.shapes.length; t++) {
                if (this.shapes[t].repelCheck(point)) {
                    return true
                }
            }

            return false
        }
        repelCheckPomao() {
            for (let t = 0; t < this.shapes.length; t++) {
                if (pomao.checkRepelPomao(this.shapes[t])) {
                    return true
                }
            }

            return false
        }
        insideCheckPomao() {
            for (let t = 0; t < this.shapes.length; t++) {
                if (pomao.body.repelCheck(this.shapes[t])) {
                    return true
                }
            }

            return false
        }
        repelCheckPomaoReturnObject() {
            for (let t = 0; t < this.shapes.length; t++) {
                if (pomao.body.repelCheck(this.shapes[t])) {
                    return this.shapes[t]
                }
            }

            return this.shapes[0]
        }
        isInsideOf(box) {

            for (let t = 0; t < this.shapes.length; t++) {
                if (box.isPointInside(this.shapes[t])) {
                    return true
                }
            }

            return false
        }
        isInsideOfShape(box) {

            for (let k = 0; k < box.length; k++) {
                for (let t = 0; t < this.shapes.length; t++) {
                    if (box[k].isPointInside(this.shapes[t])) {
                        return true
                    }
                }
            }

            return false
        }
        isPointInsideTargeted(point) {
            for (let t = 0; t < this.shapes.length; t++) {
                if (this.shapes[t].repelCheck(point)) {
                    return this.shapes[t].target
                }
            }

            return false
        }
        isPointInsideTargetedShape(point) {
            for (let t = 0; t < this.shapes.length; t++) {
                if (this.shapes[t].repelCheck(point)) {
                    return this.shapes[t]
                }
            }
            return false
        }
        isInsideOfTargeted(box) {

            for (let t = 0; t < this.shapes.length; t++) {
                if (box.isPointInside(this.shapes[t])) {
                    return this.shapes[t].target
                }
            }

            return false
        }

        draw() {
            for (let t = 0; t < this.shapes.length; t++) {
                this.shapes[t].draw()
            }
            // //////console.log(this)
        }
        filldraw() {
            tutorial_canvas_context.beginPath()
            tutorial_canvas_context.moveTo(this.shapes[0].x, this.shapes[0].y)
            for (let t = 0; t < this.shapes.length; t++) {
                tutorial_canvas_context.lineTo(this.shapes[t].x, this.shapes[t].y)
            }
            tutorial_canvas_context.lineTo(this.shapes[0].x, this.shapes[0].y)
            tutorial_canvas_context.fill()
            tutorial_canvas_context.stroke()
            tutorial_canvas_context.closePath()
            // //////console.log(this)
        }
    }



    class Pomao {
        constructor() {
            this.pote = 0 
            this.crystal = 0
            this.snowcounter = 0
            this.wallcounter = 0
            this.wavecounter = 0
            this.potecounter = 0
            this.gearcounter = 0
            this.pulsecounter = 0
            this.slopocounter = 0
            this.ripplecounter = 0
            this.splatcounter = 0
            this.spartcounter = 2
            this.spartdir = 1
            this.hngResetConstant = 11
            this.wingcheck = 0
            this.cutscene = 0
            this.grounded = 0
            this.wingthing = 0
            this.eggmake = 0
            this.rooted = {}
            this.rootedframe = 0
            this.dry = 0
            this.train = 0
            this.tongueray = []
            this.tonguebox = new Shape(this.tongueray)
            this.pausetimer = 10
            this.paused = 10
            this.fired = 0
            this.blocked = 0
            this.bonked = 0
            this.blush = 0
            this.high = 0
            this.tripping = 0
            this.eggtimer = 10
            this.egglock = 0
            this.body = new Circlex(640, 360, 32, "transparent")
            // if (cheats.megamao == 1) {
            //     this.body.radius = 64
            // }
            this.tongue = new Circlec(this.body.x, this.body.y, 6, "blue")
            // if (cheats.megamao == 1) {
            //     this.tongue.radius = 12
            // }
            this.floorcheckline = new LineOP(this.body,this.body)

            this.tonguex = 0
            this.tonguey = 0
            this.tonguexmom = 0
            this.tongueymom = 0
            this.runner = 0
            this.jumping = 1
            this.hng = 0
            this.dir = 1
            this.timeloop = 0
            this.timeloops = 0  //?
            this.timeloopx = 0
            this.thrown = []
            this.pounding = 0
            // vibrate(gamepadAPI, 100, 15)
            this.eggs = [this.body]
            this.disabled = 0
            this.hits = 9
            this.flap = 0
            this.flapstep = 0
            // this.health = new Health(this)
            this.rattled = 0

            // this.positron = new CircleF(this.body.x, this.body.y, 3, "gray", 1)
            // this.electron = new CircleF(this.body.x, this.body.y, 3, "gray", -1)
            // this.positron2 = new CircleF(this.body.x, this.body.y, 3, "gray", 0, 1)
            // this.electron2 = new CircleF(this.body.x, this.body.y, 3, "gray", 0, -1)
            this.pomarray = [
                {
                    "angle": -3.0900024820325203,
                    "length": 842.6071008397848
                },
                {
                    "angle": -3.0392171780123785,
                    "length": 711.7980972863734
                },
                {
                    "angle": -2.9864134810096097,
                    "length": 636.9785562444595
                },
                {
                    "angle": -2.9358334225802794,
                    "length": 614.3520057488349
                },
                {
                    "angle": -2.8844451529222184,
                    "length": 661.7218921853346
                },
                {
                    "angle": -2.8336751272063228,
                    "length": 993.7168833971955
                },
                {
                    "angle": -2.781301952481093,
                    "length": 1171.4495818282012
                },
                {
                    "angle": -2.731095455469834,
                    "length": 1441.9872287680628
                },
                {
                    "angle": -2.6797528311626158,
                    "length": 1631.6425505639054
                },
                {
                    "angle": -2.6271034825260573,
                    "length": 1841.0023240997107
                },
                {
                    "angle": -2.5769097656370232,
                    "length": 2002.0044637157116
                },
                {
                    "angle": -2.524802808994127,
                    "length": 2171.362869620556
                },
                {
                    "angle": -2.473706724279335,
                    "length": 2343.954666495556
                },
                {
                    "angle": -2.4200094355232338,
                    "length": 2526.117456066946
                },
                {
                    "angle": -2.36909261256157,
                    "length": 2668.253155088518
                },
                {
                    "angle": -2.31631566609945,
                    "length": 2778.2611177922226
                },
                {
                    "angle": -2.2614019791774393,
                    "length": 2936.737915082136
                },
                {
                    "angle": -2.2112901476824587,
                    "length": 3021.4888102246914
                },
                {
                    "angle": -2.160696037505721,
                    "length": 3107.1283526516636
                },
                {
                    "angle": -2.1104069021476524,
                    "length": 3245.3653981210664
                },
                {
                    "angle": -2.0602508494318093,
                    "length": 3209.3904193306807
                },
                {
                    "angle": -2.0064523875657216,
                    "length": 3041.689826641232
                },
                {
                    "angle": -1.955659478691034,
                    "length": 2910.189504919166
                },
                {
                    "angle": -1.9022140109425818,
                    "length": 2796.0286274697282
                },
                {
                    "angle": -1.8470044583786287,
                    "length": 2700.8645311929286
                },
                {
                    "angle": -1.79331531448391,
                    "length": 2627.990608844906
                },
                {
                    "angle": -1.7362238559220897,
                    "length": 2569.683492243348
                },
                {
                    "angle": -1.6823471532460736,
                    "length": 2531.368870256061
                },
                {
                    "angle": -1.618229745463697,
                    "length": 2505.6332707550027
                },
                {
                    "angle": -1.5499713958590675,
                    "length": 2501.084507908905
                },
                {
                    "angle": -1.4966669683011042,
                    "length": 2513.788389649475
                },
                {
                    "angle": -1.444887999344592,
                    "length": 2540.0549191213795
                },
                {
                    "angle": -1.3903586618258141,
                    "length": 2583.1942120195017
                },
                {
                    "angle": -1.340339972981263,
                    "length": 2637.621975956077
                },
                {
                    "angle": -1.28722802932911,
                    "length": 2712.316461799259
                },
                {
                    "angle": -1.2355562128285356,
                    "length": 2803.4395905282
                },
                {
                    "angle": -1.181284679948892,
                    "length": 2921.2431168533512
                },
                {
                    "angle": -1.1300671666688695,
                    "length": 3056.1852464224794
                },
                {
                    "angle": -1.0786317869981805,
                    "length": 3218.70028978592
                },
                {
                    "angle": -1.0271344756720624,
                    "length": 3228.1530473507155
                },
                {
                    "angle": -0.9740760045706093,
                    "length": 3132.988634953639
                },
                {
                    "angle": -0.9217978898763471,
                    "length": 3071.676886415633
                },
                {
                    "angle": -0.8657554822466478,
                    "length": 3009.26870731487
                },
                {
                    "angle": -0.8152188751019344,
                    "length": 2926.933507591617
                },
                {
                    "angle": -0.7624007527783836,
                    "length": 2849.3900081778556
                },
                {
                    "angle": -0.7086215199670778,
                    "length": 2692.846094577413
                },
                {
                    "angle": -0.6549065072027261,
                    "length": 2533.532179980364
                },
                {
                    "angle": -0.603289571976316,
                    "length": 2419.3242835105775
                },
                {
                    "angle": -0.5518998082866706,
                    "length": 2313.2561390686897
                },
                {
                    "angle": -0.5010306587602077,
                    "length": 2180.405643081758
                },
                {
                    "angle": -0.4501810182395141,
                    "length": 2063.9012632955128
                },
                {
                    "angle": -0.393223942660539,
                    "length": 1894.057948321235
                },
                {
                    "angle": -0.33879755972622005,
                    "length": 1756.8387373877922
                },
                {
                    "angle": -0.28869600296870723,
                    "length": 1668.381536392044
                },
                {
                    "angle": -0.2377141567864178,
                    "length": 1573.9203915882972
                },
                {
                    "angle": -0.18445250405077204,
                    "length": 1423.3618544031197
                },
                {
                    "angle": -0.13444414619250972,
                    "length": 1294.5140864540008
                },
                {
                    "angle": -0.0839432369934708,
                    "length": 1187.9510239721421
                },
                {
                    "angle": -0.03093684961144852,
                    "length": 1074.767495660868
                },
                {
                    "angle": 0.022023985571814616,
                    "length": 963.5506732130889
                },
                {
                    "angle": 0.07503083858795291,
                    "length": 890.34369653475
                },
                {
                    "angle": 0.12865429706753992,
                    "length": 810.3864279534318
                },
                {
                    "angle": 0.17973656145765743,
                    "length": 755.1160594393732
                },
                {
                    "angle": 0.23127406347510263,
                    "length": 706.94122585078
                },
                {
                    "angle": 0.282109425590053,
                    "length": 671.5463459445746
                },
                {
                    "angle": 0.3338382610056162,
                    "length": 635.1143539692857
                },
                {
                    "angle": 0.38778931978909664,
                    "length": 601.306914901943
                },
                {
                    "angle": 0.44025044466941005,
                    "length": 583.8736032343586
                },
                {
                    "angle": 0.4941993434605133,
                    "length": 575.8158338285284
                },
                {
                    "angle": 0.5491581447539602,
                    "length": 563.3610157729709
                },
                {
                    "angle": 0.6046067533442996,
                    "length": 554.2780565882567
                },
                {
                    "angle": 0.6562025769033171,
                    "length": 556.7619833970675
                },
                {
                    "angle": 0.7085511821153687,
                    "length": 556.7115173508646
                },
                {
                    "angle": 0.7639297288018813,
                    "length": 566.6059825589182
                },
                {
                    "angle": 0.8170516076819963,
                    "length": 576.0560390353785
                },
                {
                    "angle": 0.8708792558546752,
                    "length": 593.1579815126606
                },
                {
                    "angle": 0.9253850900369438,
                    "length": 618.207773323229
                },
                {
                    "angle": 0.9785656386631345,
                    "length": 635.6227161027491
                },
                {
                    "angle": 1.031645311377938,
                    "length": 675.6658563186647
                },
                {
                    "angle": 1.0873874355152848,
                    "length": 723.2475410915213
                },
                {
                    "angle": 1.1387523975385965,
                    "length": 762.91072909371
                },
                {
                    "angle": 1.1890435271751802,
                    "length": 799.6826050973614
                },
                {
                    "angle": 1.2409448483243457,
                    "length": 821.7677111030207
                },
                {
                    "angle": 1.2933807230491594,
                    "length": 835.0376960850554
                },
                {
                    "angle": 1.3454974980362069,
                    "length": 841.7030881048413
                },
                {
                    "angle": 1.3992788365438618,
                    "length": 917.3733254219987
                },
                {
                    "angle": 1.4506687212318976,
                    "length": 1827.7876862705598
                },
                {
                    "angle": 1.5039984926214207,
                    "length": 2004.2965968454519
                },
                {
                    "angle": 1.5556885136391267,
                    "length": 2028.7688527883292
                },
                {
                    "angle": 1.6063967944478499,
                    "length": 2088.4230398226646
                },
                {
                    "angle": 1.6584500544374525,
                    "length": 2031.9323431791418
                },
                {
                    "angle": 1.7094435084179394,
                    "length": 1791.264011037434
                },
                {
                    "angle": 1.7609272816479649,
                    "length": 1331.2000438310206
                },
                {
                    "angle": 1.8127226104517642,
                    "length": 1161.2795546806447
                },
                {
                    "angle": 1.8627704219273011,
                    "length": 1216.3950152421603
                },
                {
                    "angle": 1.913414757519883,
                    "length": 2333.5566812457546
                },
                {
                    "angle": 1.963660139081041,
                    "length": 2362.4716713573434
                },
                {
                    "angle": 2.014253081958968,
                    "length": 2274.605719452098
                },
                {
                    "angle": 2.065026221426755,
                    "length": 2088.9737368466012
                },
                {
                    "angle": 2.1164139421161234,
                    "length": 1797.9861213304102
                },
                {
                    "angle": 2.1717729019930436,
                    "length": 1514.4161449863022
                },
                {
                    "angle": 2.223224086210891,
                    "length": 1549.813527673672
                },
                {
                    "angle": 2.274319798803,
                    "length": 1573.7614479542972
                },
                {
                    "angle": 2.3254452924597784,
                    "length": 1625.7696896546583
                },
                {
                    "angle": 2.376947145839857,
                    "length": 1696.1245593978674
                },
                {
                    "angle": 2.428165777144579,
                    "length": 1733.7370209885994
                },
                {
                    "angle": 2.481553838496098,
                    "length": 1778.1765819765278
                },
                {
                    "angle": 2.5324049771051538,
                    "length": 1783.7179315710673
                },
                {
                    "angle": 2.5828162552763403,
                    "length": 1807.7397730972734
                },
                {
                    "angle": 2.6376626729809476,
                    "length": 1782.9235605481663
                },
                {
                    "angle": 2.688396767607974,
                    "length": 1726.678378630022
                },
                {
                    "angle": 2.743257458565758,
                    "length": 1657.4363720776164
                },
                {
                    "angle": 2.7940877541480247,
                    "length": 1592.794274246844
                },
                {
                    "angle": 2.8449544469718453,
                    "length": 1539.617986006895
                },
                {
                    "angle": 2.8951938875276824,
                    "length": 1476.3267997934017
                },
                {
                    "angle": 2.94757483429578,
                    "length": 1366.8568774082814
                },
                {
                    "angle": 2.9985409918048065,
                    "length": 1246.621762840834
                },
                {
                    "angle": 3.0494937955340284,
                    "length": 1123.6036556435865
                },
                {
                    "angle": 3.100608769042309,
                    "length": 1017.625220196438
                }
            ]
            this.pomarrayleft = [
                {
                    "angle": -3.127411769756162,
                    "length": 1078.2106881571235
                },
                {
                    "angle": -3.0771016485706926,
                    "length": 1137.362238745729
                },
                {
                    "angle": -3.026025692309955,
                    "length": 1236.4692576027592
                },
                {
                    "angle": -2.9754242903904986,
                    "length": 1390.5597063995083
                },
                {
                    "angle": -2.923605611542274,
                    "length": 1512.8581265616813
                },
                {
                    "angle": -2.8732902188991405,
                    "length": 1637.7391706992057
                },
                {
                    "angle": -2.8226734806080565,
                    "length": 1761.2957837963477
                },
                {
                    "angle": -2.7708868709479977,
                    "length": 1863.2112421990023
                },
                {
                    "angle": -2.7190537864313664,
                    "length": 2004.2293023061939
                },
                {
                    "angle": -2.6688362534694883,
                    "length": 2154.1270884157275
                },
                {
                    "angle": -2.6182969207826745,
                    "length": 2287.240950775158
                },
                {
                    "angle": -2.5675385296700437,
                    "length": 2440.4244592238683
                },
                {
                    "angle": -2.516987080578789,
                    "length": 2577.3083098317147
                },
                {
                    "angle": -2.466835229165751,
                    "length": 2671.640319931612
                },
                {
                    "angle": -2.415678887684283,
                    "length": 2778.954873027804
                },
                {
                    "angle": -2.3654655703689027,
                    "length": 2914.4357440520544
                },
                {
                    "angle": -2.312812617132903,
                    "length": 2940.448842909478
                },
                {
                    "angle": -2.262306403983799,
                    "length": 3011.5182513953187
                },
                {
                    "angle": -2.21168074641381,
                    "length": 3077.1848588085268
                },
                {
                    "angle": -2.1605035485316977,
                    "length": 3156.406195073214
                },
                {
                    "angle": -2.1101385928879868,
                    "length": 3230.438608694123
                },
                {
                    "angle": -2.0596951740595646,
                    "length": 3156.3784642696846
                },
                {
                    "angle": -2.008998479258629,
                    "length": 3014.160182523774
                },
                {
                    "angle": -1.9581116359601003,
                    "length": 2910.4413125038263
                },
                {
                    "angle": -1.907822248088823,
                    "length": 2814.4010550380335
                },
                {
                    "angle": -1.8572280340723162,
                    "length": 2724.0925406814204
                },
                {
                    "angle": -1.8046854953486573,
                    "length": 2661.0140480520204
                },
                {
                    "angle": -1.7522570600900247,
                    "length": 2618.7597769380664
                },
                {
                    "angle": -1.702185575801875,
                    "length": 2595.269969892688
                },
                {
                    "angle": -1.6502688764323794,
                    "length": 2606.5227611828595
                },
                {
                    "angle": -1.5979333040637673,
                    "length": 2597.257766733237
                },
                {
                    "angle": -1.547077178021175,
                    "length": 2596.806259322213
                },
                {
                    "angle": -1.4954779319774714,
                    "length": 2592.3833317042445
                },
                {
                    "angle": -1.4428715653422803,
                    "length": 2576.587096083269
                },
                {
                    "angle": -1.3922770487755614,
                    "length": 2592.056842212798
                },
                {
                    "angle": -1.3418484838705775,
                    "length": 2682.9204552555457
                },
                {
                    "angle": -1.2900902256443207,
                    "length": 2787.5166116142645
                },
                {
                    "angle": -1.2391826596302224,
                    "length": 2878.710231921694
                },
                {
                    "angle": -1.1882561308123871,
                    "length": 3008.4931312371045
                },
                {
                    "angle": -1.137647077924563,
                    "length": 3143.019115247822
                },
                {
                    "angle": -1.0871186861169617,
                    "length": 3303.775696873723
                },
                {
                    "angle": -1.0354736129359698,
                    "length": 3341.7923977852333
                },
                {
                    "angle": -0.98500579958961,
                    "length": 3194.8506556631182
                },
                {
                    "angle": -0.9344768144997845,
                    "length": 3010.9234768354945
                },
                {
                    "angle": -0.8835306545737108,
                    "length": 2942.187966518468
                },
                {
                    "angle": -0.8326929557933133,
                    "length": 2869.0562328100787
                },
                {
                    "angle": -0.7806171545948313,
                    "length": 2715.5039824939013
                },
                {
                    "angle": -0.7290408995220169,
                    "length": 2523.4058318818134
                },
                {
                    "angle": -0.678893382358401,
                    "length": 2373.5357673991384
                },
                {
                    "angle": -0.6275005156285277,
                    "length": 2207.333249735879
                },
                {
                    "angle": -0.5761336665583278,
                    "length": 2086.4210784077877
                },
                {
                    "angle": -0.5259071524748967,
                    "length": 1961.487106382905
                },
                {
                    "angle": -0.4756503922103153,
                    "length": 1816.173159093887
                },
                {
                    "angle": -0.4237145655085014,
                    "length": 1520.767570226235
                },
                {
                    "angle": -0.37367143586804413,
                    "length": 1259.4550411224482
                },
                {
                    "angle": -0.3228855600430013,
                    "length": 1080.5778367042803
                },
                {
                    "angle": -0.27274562968208443,
                    "length": 790.2736423838796
                },
                {
                    "angle": -0.2223266367011554,
                    "length": 626.0660562157864
                },
                {
                    "angle": -0.16678195444069532,
                    "length": 602.081382322358
                },
                {
                    "angle": -0.11463031287666091,
                    "length": 629.0569596934365
                },
                {
                    "angle": -0.06393412603678986,
                    "length": 742.2322680235375
                },
                {
                    "angle": -0.012316321942961833,
                    "length": 866.3297502994683
                },
                {
                    "angle": 0.037998607719853694,
                    "length": 989.9905408323539
                },
                {
                    "angle": 0.08961308750587366,
                    "length": 1119.049391626162
                },
                {
                    "angle": 0.14003339012531266,
                    "length": 1261.3028378702002
                },
                {
                    "angle": 0.19230789361857067,
                    "length": 1354.3175487744884
                },
                {
                    "angle": 0.2426860313199931,
                    "length": 1477.1166109669866
                },
                {
                    "angle": 0.29413406725269176,
                    "length": 1561.757445623938
                },
                {
                    "angle": 0.3461167379944047,
                    "length": 1635.2928684855142
                },
                {
                    "angle": 0.39686473189681215,
                    "length": 1710.2917607021518
                },
                {
                    "angle": 0.4489510974719858,
                    "length": 1762.7953168845852
                },
                {
                    "angle": 0.4997050871048781,
                    "length": 1816.0090387452074
                },
                {
                    "angle": 0.5502655464261379,
                    "length": 1847.9508946466522
                },
                {
                    "angle": 0.6018256113592149,
                    "length": 1846.175576635651
                },
                {
                    "angle": 0.6530985904099822,
                    "length": 1838.9436341953697
                },
                {
                    "angle": 0.7052430300619456,
                    "length": 1787.5393160725507
                },
                {
                    "angle": 0.755838722802763,
                    "length": 1731.150548986232
                },
                {
                    "angle": 0.8067134610556763,
                    "length": 1674.9303730190295
                },
                {
                    "angle": 0.8585169800022312,
                    "length": 1614.154766007705
                },
                {
                    "angle": 0.9098218547361074,
                    "length": 1592.1713387132186
                },
                {
                    "angle": 0.9610343863595476,
                    "length": 1656.606947503169
                },
                {
                    "angle": 1.0112517273086032,
                    "length": 1775.2894670951791
                },
                {
                    "angle": 1.0618212063041776,
                    "length": 1989.0179855609458
                },
                {
                    "angle": 1.1156849594624938,
                    "length": 2177.1928731322405
                },
                {
                    "angle": 1.1663399723699939,
                    "length": 2287.4840961790323
                },
                {
                    "angle": 1.2171561963039412,
                    "length": 2336.2514293289423
                },
                {
                    "angle": 1.269015616272444,
                    "length": 2283.0395341634867
                },
                {
                    "angle": 1.3191350047433268,
                    "length": 1984.21725959779
                },
                {
                    "angle": 1.3697494104368375,
                    "length": 1602.3777513981331
                },
                {
                    "angle": 1.4203838141409748,
                    "length": 1625.0718342650362
                },
                {
                    "angle": 1.4705347134049662,
                    "length": 1759.384577236211
                },
                {
                    "angle": 1.5214125243908168,
                    "length": 1870.866188548811
                },
                {
                    "angle": 1.5719649782657066,
                    "length": 1888.7193907047185
                },
                {
                    "angle": 1.6220326109467527,
                    "length": 1879.5488488102128
                },
                {
                    "angle": 1.6729343817691562,
                    "length": 1787.640785990996
                },
                {
                    "angle": 1.7239336401201633,
                    "length": 1673.7574330568896
                },
                {
                    "angle": 1.7748055420949795,
                    "length": 1262.9886059475248
                },
                {
                    "angle": 1.825907036654489,
                    "length": 1022.7421966195834
                },
                {
                    "angle": 1.8775152777933413,
                    "length": 876.2208143568714
                },
                {
                    "angle": 1.9307537790615477,
                    "length": 760.9355929017183
                },
                {
                    "angle": 1.9810647146032265,
                    "length": 705.4544661141117
                },
                {
                    "angle": 2.031527997422867,
                    "length": 675.8722517276765
                },
                {
                    "angle": 2.0822937216484987,
                    "length": 660.7327858901699
                },
                {
                    "angle": 2.137146431081851,
                    "length": 654.3281609202386
                },
                {
                    "angle": 2.189216866334204,
                    "length": 641.1418626928935
                },
                {
                    "angle": 2.23928039844635,
                    "length": 621.0045892382623
                },
                {
                    "angle": 2.298285787312431,
                    "length": 589.6307377934572
                },
                {
                    "angle": 2.3487216987116533,
                    "length": 577.2089324999251
                },
                {
                    "angle": 2.4024167760178923,
                    "length": 569.482211899769
                },
                {
                    "angle": 2.455083479386079,
                    "length": 564.1930066061323
                },
                {
                    "angle": 2.5051476974914655,
                    "length": 565.628050510888
                },
                {
                    "angle": 2.5559545982763705,
                    "length": 572.1457435513148
                },
                {
                    "angle": 2.6060134755709217,
                    "length": 585.3972298885346
                },
                {
                    "angle": 2.6574292201604655,
                    "length": 591.4749930525431
                },
                {
                    "angle": 2.70937294873381,
                    "length": 596.2067954922677
                },
                {
                    "angle": 2.761785973825037,
                    "length": 609.0131305575487
                },
                {
                    "angle": 2.81425298063536,
                    "length": 639.1954037929536
                },
                {
                    "angle": 2.864409950846538,
                    "length": 678.0836799335666
                },
                {
                    "angle": 2.915929902352013,
                    "length": 699.534228346427
                },
                {
                    "angle": 2.968969251151705,
                    "length": 745.4786960005877
                },
                {
                    "angle": 3.0204698923751563,
                    "length": 816.3948018170195
                },
                {
                    "angle": 3.0711543030881443,
                    "length": 886.9942358779954
                },
                {
                    "angle": 3.121601802791772,
                    "length": 997.231482725183
                }
            ]


            for (let t = 0; t < 10; t++) {
                let pomarray2 = []
                for (let t = 0; t < this.pomarray.length - 1; t++) {
                    let obj = {}
                    obj.angle = (this.pomarray[t].angle + this.pomarray[t + 1].angle) * .5
                    obj.length = (this.pomarray[t].length + this.pomarray[t + 1].length) * .5
                    pomarray2.push(this.pomarray[t])
                    pomarray2.push(obj)
                }
                this.pomarray = [...pomarray2]
            }

            for (let t = 0; t < 10; t++) {
                let pomarray2 = []
                for (let t = 0; t < this.pomarrayleft.length - 1; t++) {
                    let obj = {}
                    obj.angle = (this.pomarrayleft[t].angle + this.pomarrayleft[t + 1].angle) * .5
                    obj.length = (this.pomarrayleft[t].length + this.pomarrayleft[t + 1].length) * .5
                    pomarray2.push(this.pomarrayleft[t])
                    pomarray2.push(obj)
                }
                this.pomarrayleft = [...pomarray2]
            }


            // //////console.log(this.pomarray, this.pomarrayleft)

            this.angleincrement = (Math.PI * 2) / this.pomarray.length
            this.angleincrementleft = (Math.PI * 2) / this.pomarrayleft.length


            let zero = Math.PI
            this.angleincrement = (Math.PI * 2) / this.pomarray.length


            for (let t = 0; t < this.pomarray.length; t++) {
                this.pomarray[t].angle = zero
                this.pomarray[t].length = Math.sqrt(this.pomarray[t].length)
                zero += this.angleincrement
            }

            zero = Math.PI
            this.angleincrementleft = (Math.PI * 2) / this.pomarrayleft.length


            for (let t = 0; t < this.pomarrayleft.length; t++) {
                this.pomarrayleft[t].angle = zero
                this.pomarrayleft[t].length = Math.sqrt(this.pomarrayleft[t].length)
                zero += this.angleincrementleft
            }

            this.angleincrement = 1 / this.angleincrement
            this.angleincrementleft = 1 / this.angleincrementleft


        }
        checkInsidePomao(point) {
            this.body.x = 200
            this.body.y = 180
            this.body.radius = 140
            let link = new LineOP(this.body, point) // line between objects
            let angle = link.angle() + Math.PI // angle adjusted
            let dis = link.hypotenuse()  // get distance (could be a square check, rather than a function distance)
            if (this.dir == 1) {
                let t = Math.floor((angle) * this.angleincrement) // calculate the index of the angle 
                t %= this.pomarray.length - 1 // get the index without a loop
                if (dis < ((this.pomarray[t].length + this.pomarray[t + 1].length) * .5) * ((this.body.radius) * .02)) { // normalized to character size
                    return true // collision
                }
            } else { // same as above but for the other direction (this.dir = -1)
                let t = Math.floor((angle) * this.angleincrementleft)
                t %= this.pomarrayleft.length - 1
                if (dis < ((this.pomarrayleft[t].length + this.pomarrayleft[t + 1].length) * .5) * ((this.body.radius) * .02)) {
                    return true
                }
            }
            return false
        }
        checkInsidePomaoPolar(point) {
            this.body.x = 200
            this.body.y = 180
            this.body.radius = 140
            point.x*=1
            point.y*=1
            point.x=this.body.x-point.x
            point.y=this.body.y-point.y
            point.x += 210
            point.y += 200
            let link = new LineOP(this.body, point) // line between objects
            let angle = link.angle() + Math.PI // angle adjusted
            let dis = link.hypotenuse()  // get distance (could be a square check, rather than a function distance)
            if (this.dir == 1) {
                let t = Math.floor((angle) * this.angleincrement) // calculate the index of the angle 
                t %= this.pomarray.length - 1 // get the index without a loop
                if (dis < ((this.pomarray[t].length + this.pomarray[t + 1].length) * .5) * ((this.body.radius) * .0052)) { // normalized to character size
                    return true // collision
                }
            } else { // same as above but for the other direction (this.dir = -1)
                let t = Math.floor((angle) * this.angleincrementleft)
                t %= this.pomarrayleft.length - 1
                if (dis < ((this.pomarrayleft[t].length + this.pomarrayleft[t + 1].length) * .5) * ((this.body.radius) * .0052)) {
                    return true
                }
            }
            return false
        }
        checkRepelPomao(point) {
            let link = new LineOP(this.body, point) // line between objects
            let angle = link.angle() + Math.PI // angle adjusted
            let dis = link.hypotenuse() - point.radius // get distance (could be a square check, rather than a function distance)
            if (this.dir == 1) {
                let t = Math.floor((angle) * this.angleincrement) // calculate the index of the angle 
                t %= this.pomarray.length - 1 // get the index without a loop
                if (dis < ((this.pomarray[t].length + this.pomarray[t + 1].length) * .5) * ((this.body.radius) * .02)) { // normalized to character size
                    return true // collision
                }
            } else { // same as above but for the other direction (this.dir = -1)
                let t = Math.floor((angle) * this.angleincrementleft)
                t %= this.pomarrayleft.length - 1
                if (dis < ((this.pomarrayleft[t].length + this.pomarrayleft[t + 1].length) * .5) * ((this.body.radius) * .02)) {
                    return true
                }
            }
            return false

        }

    }


    let pomao = new Pomao()



    function CanvasCaptureToWEBM(canvas, bitrate) {
        // the video_recorder is set to  '= new CanvasCaptureToWEBM(canvas, 4500000);' in the setup, 
        // it uses the same canvas as the rest of the file.
        // to start a recording call .record() on video_recorder
        /*
        for example, 
        if(keysPressed['-'] && recording == 0){
            recording = 1
            video_recorder.record()
        }
        if(keysPressed['='] && recording == 1){
            recording = 0
            video_recorder.stop()
            video_recorder.download('File Name As A String.webm')
        }
        */
        this.record = Record
        this.stop = Stop
        this.download = saveToDownloads
        let blobCaptures = []
        let outputFormat = {}
        let recorder = {}
        let canvasInput = canvas.captureStream()
        if (typeof canvasInput == undefined || !canvasInput) {
            return
        }
        const video = document.createElement('video')
        video.style.display = 'none'

        function Record() {
            let formats = [
                "video/webm\;codecs=h264",
                "video/webm\;codecs=vp8",
                'video/vp8',
                "video/webm",
                'video/webm,codecs=vp9',
                "video/webm\;codecs=daala",
                "video/mpeg"
            ];

            for (let t = 0; t < formats.length; t++) {
                if (MediaRecorder.isTypeSupported(formats[t])) {
                    outputFormat = formats[t]
                    break
                }
            }
            if (typeof outputFormat != "string") {
                return
            } else {
                let videoSettings = {
                    mimeType: outputFormat,
                    videoBitsPerSecond: bitrate || 2000000 // 2Mbps
                };
                blobCaptures = []
                try {
                    recorder = new MediaRecorder(canvasInput, videoSettings)
                } catch (error) {
                    return;
                }
                recorder.onstop = handleStop
                recorder.ondataavailable = handleAvailableData
                recorder.start(100)
            }
        }
        function handleAvailableData(event) {
            if (event.data && event.data.size > 0) {
                blobCaptures.push(event.data)
            }
        }
        function handleStop() {
            const superBuffer = new Blob(blobCaptures, { type: outputFormat })
            video.src = window.URL.createObjectURL(superBuffer)
        }
        function Stop() {
            recorder.stop()
            video.controls = true
        }
        function saveToDownloads(input) { // specifying a file name for the output
            const name = input || 'video_out.webm'
            const blob = new Blob(blobCaptures, { type: outputFormat })
            const url = window.URL.createObjectURL(blob)
            const storageElement = document.createElement('a')
            storageElement.style.display = 'none'
            storageElement.href = url
            storageElement.download = name
            document.body.appendChild(storageElement)
            storageElement.click()
            setTimeout(() => {
                document.body.removeChild(storageElement)
                window.URL.revokeObjectURL(url)
            }, 100)
        }
    }

	var simHeight = 1;	
	var cScale = canvas.height / simHeight;
	var simWidth = canvas.width / cScale;

	var U_FIELD = 0;
	var V_FIELD = 1;
	var S_FIELD = 2;

	var cnt = 0;

	function cX(x) {
		return x * cScale;
	}

	function cY(y) {
		return canvas.height - y * cScale;
	}

	// ----------------- start of simulator ------------------------------

    let keysPressed = {}
        document.addEventListener('keydown', (event) => {
            keysPressed[event.key] = true;
        });
        document.addEventListener('keyup', (event) => {
            delete keysPressed[event.key];
        });
	class Fluid {
		constructor(density, numX, numY, h) {
			this.density = density;
			this.numX = numX + 2; 
			this.numY = numY + 2;
			this.numCells = this.numX * this.numY;
			this.h = h;
			this.u = new Float32Array(this.numCells);
			this.v = new Float32Array(this.numCells);
			this.newU = new Float32Array(this.numCells);
			this.newV = new Float32Array(this.numCells);
			this.p = new Float32Array(this.numCells);
			this.s = new Float32Array(this.numCells);
			this.m = new Float32Array(this.numCells);
			this.newM = new Float32Array(this.numCells);
			this.m.fill(1.0)
			var num = numX * numY;
		}

		integrate(dt, gravity) {
			var n = this.numY;
			for (var i = 1; i < this.numX; i++) {
				for (var j = 1; j < this.numY-1; j++) {
					if (this.s[i*n + j] != 0.0 && this.s[i*n + j-1] != 0.0)
						this.v[i*n + j] += gravity * dt;
				}	 
			}
		}

		solveIncompressibility(numIters, dt) {

			var n = this.numY;
			var cp = this.density * this.h / dt;

			for (var iter = 0; iter < numIters; iter++) {

				for (var i = 1; i < this.numX-1; i++) {
					for (var j = 1; j < this.numY-1; j++) {

						if (this.s[i*n + j] == 0.0)
							continue;

						var s = this.s[i*n + j];
						var sx0 = this.s[(i-1)*n + j];
						var sx1 = this.s[(i+1)*n + j];
						var sy0 = this.s[i*n + j-1];
						var sy1 = this.s[i*n + j+1];
						var s = sx0 + sx1 + sy0 + sy1;
						if (s == 0.0)
							continue;

						var div = this.u[(i+1)*n + j] - this.u[i*n + j] + 
							this.v[i*n + j+1] - this.v[i*n + j];

						var p = -div / s;
						p *= scene.overRelaxation;
						this.p[i*n + j] += cp * p;

						this.u[i*n + j] -= sx0 * p;
						this.u[(i+1)*n + j] += sx1 * p;
						this.v[i*n + j] -= sy0 * p;
						this.v[i*n + j+1] += sy1 * p;
					}
				}
			}
		}

		extrapolate() {
			var n = this.numY;
			for (var i = 0; i < this.numX; i++) {
				this.u[i*n + 0] = this.u[i*n + 1];
				this.u[i*n + this.numY-1] = this.u[i*n + this.numY-2]; 
			}
			for (var j = 0; j < this.numY; j++) {
				this.v[0*n + j] = this.v[1*n + j];
				this.v[(this.numX-1)*n + j] = this.v[(this.numX-2)*n + j] 
			}
		}

		sampleField(x, y, field) {
			var n = this.numY;
			var h = this.h;
			var h1 = 1.0 / h;
			var h2 = 0.5 * h;

			x = Math.max(Math.min(x, this.numX * h), h);
			y = Math.max(Math.min(y, this.numY * h), h);

			var dx = 0.0;
			var dy = 0.0;

			var f;

			switch (field) {
				case U_FIELD: f = this.u; dy = h2; break;
				case V_FIELD: f = this.v; dx = h2; break;
				case S_FIELD: f = this.m; dx = h2; dy = h2; break

			}

			var x0 = Math.min(Math.floor((x-dx)*h1), this.numX-1);
			var tx = ((x-dx) - x0*h) * h1;
			var x1 = Math.min(x0 + 1, this.numX-1);
			
			var y0 = Math.min(Math.floor((y-dy)*h1), this.numY-1);
			var ty = ((y-dy) - y0*h) * h1;
			var y1 = Math.min(y0 + 1, this.numY-1);

			var sx = 1.0 - tx;
			var sy = 1.0 - ty;

			var val = sx*sy * f[x0*n + y0] +
				tx*sy * f[x1*n + y0] +
				tx*ty * f[x1*n + y1] +
				sx*ty * f[x0*n + y1];
			
			return val;
		}

		avgU(i, j) {
			var n = this.numY;
			var u = (this.u[i*n + j-1] + this.u[i*n + j] +
				this.u[(i+1)*n + j-1] + this.u[(i+1)*n + j]) * 0.25;
			return u;
				
		}

		avgV(i, j) {
			var n = this.numY;
			var v = (this.v[(i-1)*n + j] + this.v[i*n + j] +
				this.v[(i-1)*n + j+1] + this.v[i*n + j+1]) * 0.25;
			return v;
		}

		advectVel(dt) {

			this.newU.set(this.u);
			this.newV.set(this.v);

			var n = this.numY;
			var h = this.h;
			var h2 = 0.5 * h;

			for (var i = 1; i < this.numX; i++) {
				for (var j = 1; j < this.numY; j++) {

					cnt++;

					// u component
					if (this.s[i*n + j] != 0.0 && this.s[(i-1)*n + j] != 0.0 && j < this.numY - 1) {
						var x = i*h;
						var y = j*h + h2;
						var u = this.u[i*n + j];
						var v = this.avgV(i, j);
//						var v = this.sampleField(x,y, V_FIELD);
						x = x - dt*u;
						y = y - dt*v;
						u = this.sampleField(x,y, U_FIELD);
						this.newU[i*n + j] = u;
					}
					// v component
					if (this.s[i*n + j] != 0.0 && this.s[i*n + j-1] != 0.0 && i < this.numX - 1) {
						var x = i*h + h2;
						var y = j*h;
						var u = this.avgU(i, j);
//						var u = this.sampleField(x,y, U_FIELD);
						var v = this.v[i*n + j];
						x = x - dt*u;
						y = y - dt*v;
						v = this.sampleField(x,y, V_FIELD);
						this.newV[i*n + j] = v;
					}
				}	 
			}

			this.u.set(this.newU);
			this.v.set(this.newV);
		}

		advectSmoke(dt) {

			this.newM.set(this.m);

			var n = this.numY;
			var h = this.h;
			var h2 = 0.5 * h;

			for (var i = 1; i < this.numX-1; i++) {
				for (var j = 1; j < this.numY-1; j++) {

					if (this.s[i*n + j] != 0.0) {
						var u = (this.u[i*n + j] + this.u[(i+1)*n + j]) * 0.5;
						var v = (this.v[i*n + j] + this.v[i*n + j+1]) * 0.5;
						var x = i*h + h2 - dt*u;
						var y = j*h + h2 - dt*v;

						this.newM[i*n + j] = this.sampleField(x,y, S_FIELD);
 					}
				}	 
			}
			this.m.set(this.newM);
		}

		// ----------------- end of simulator ------------------------------


		simulate(dt, gravity, numIters) {

			this.integrate(dt, gravity);

			this.p.fill(0.0);
			this.solveIncompressibility(numIters, dt);

			this.extrapolate();
			this.advectVel(dt);
			this.advectSmoke(dt);
		}
	}

	var scene = 
	{
		gravity : -9.81,
		dt : 1.0 / 120.0,
		numIters : 100,
		frameNr : 0,
		overRelaxation : 1.9,
		obstacleX : 0.0,
		obstacleY : 0.0,
		obstacleRadius: 0.15,
		paused: false,
		sceneNr: 0,
		showObstacle: false,
		showStreamlines: false,
		showVelocities: false,	
		showPressure: false,
		showSmoke: true,
		fluid: null
	};

	function setupScene(sceneNr = 0) 
	{
		scene.sceneNr = sceneNr;
		scene.obstacleRadius = 0.20;
		scene.overRelaxation = 1.9;

		scene.dt = 1.0 / 400.0;
		scene.numIters = 30;

		var res = 400;
		
		if (sceneNr == 0)
			res = 50;
		else if (sceneNr == 3)
			res = 400;

		var domainHeight = 1.0;
		var domainWidth = domainHeight / simHeight * simWidth;
		var h = domainHeight / res;

		var numX = Math.floor(domainWidth / h);
		var numY = Math.floor(domainHeight / h);

		var density = 100.0;

		f = scene.fluid = new Fluid(density, numX, numY, h);

		var n = f.numY;

		if (sceneNr == 0) {   		// tank

			for (var i = 0; i < f.numX; i++) {
				for (var j = 0; j < f.numY; j++) {
					var s = 1.0;	// fluid
					if (i == 0 || i == f.numX-1 || j == 0)
						s = 0.0;	// solid
					f.s[i*n + j] = s
				}
			}
			scene.gravity = -9.81;
			scene.showPressure = true;
			scene.showSmoke = false;
			scene.showStreamlines = false;
			scene.showVelocities = false;
		}
		else if (sceneNr == 1 || sceneNr == 3) { // vortex shedding

			var inVel = 2.0;
			for (var i = 0; i < f.numX; i++) {
				for (var j = 0; j < f.numY; j++) {
					var s = 1.0;	// fluid
					if (i == 0 || j == 0 || j == f.numY-1)
						s = 0.0;	// solid
					f.s[i*n + j] = s

					if (i == 1) {
						f.u[i*n + j] = inVel;
					}
				}
			}

			var pipeH = 0.1 * f.numY;
			var minJ = Math.floor(0.5 * f.numY - 0.5*pipeH);
			var maxJ = Math.floor(0.5 * f.numY + 0.5*pipeH);

			for (var j = minJ; j < maxJ; j++)
				f.m[j] = 0.0;

			setObstacle(0.4, 0.5, true)

			scene.gravity = 0.0;
			scene.showPressure = false;
			scene.showSmoke = true;
			scene.showStreamlines = false;
			scene.showVelocities = false;

			if (sceneNr == 3) {
				scene.dt = 1.0 / 120.0;
				scene.numIters = 100;
				scene.showPressure = true;
			}

		}
		else if (sceneNr == 2) { // paint

			scene.gravity = 0.0;
			scene.overRelaxation = 1.0;
			scene.showPressure = false;
			scene.showSmoke = true;
			scene.showStreamlines = false;
			scene.showVelocities = false;
			scene.obstacleRadius = 0.1;
		}

		document.getElementById("streamButton").checked = scene.showStreamlines;
		document.getElementById("velocityButton").checked = scene.showVelocities;
		document.getElementById("pressureButton").checked = scene.showPressure;
		document.getElementById("smokeButton").checked = scene.showSmoke;
		document.getElementById("overrelaxButton").checked = scene.overRelaxation > 1.0;
		
	}


	// draw -------------------------------------------------------

	function setColor(r,g,b) {
		c.fillStyle = `rgb(
			${Math.floor(255*r)},
			${Math.floor(255*g)},
			${Math.floor(255*b)})`
		c.strokeStyle = `rgb(
			${Math.floor(255*r)},
			${Math.floor(255*g)},
			${Math.floor(255*b)})`
	}

	function getSciColor(val, minVal, maxVal) {
		val = Math.min(Math.max(val, minVal), maxVal- 0.0001);
		var d = maxVal - minVal;
		val = d == 0.0 ? 0.5 : (val - minVal) / d;
		var m = 0.25;
		var num = Math.floor(val / m);
		var s = (val - num * m) / m;
		var r, g, b;

		switch (num) {
			case 0 : r = 0.0; g = s; b = 1.0; break;
			case 1 : r = 0.0; g = 1.0; b = 1.0-s; break;
			case 2 : r = s; g = 1.0; b = 0.0; break;
			case 3 : r = 1.0; g = 1.0 - s; b = 0.0; break;
		}

		return[255*g,255*b,255*r, 255]
	}

    function Indexer(num){
        let xs = Math.min(Math.max(Math.floor(num/4)%640,0),640)
        let ys = Math.min(Math.max(Math.floor(num/(640*4)),0),640)

        let points = [{'x':Math.max(xs-1,0),'y':Math.max(ys-1,0)},{'x':xs,'y':Math.max(ys-1,0)},{'x':Math.min(xs+1,100),'y':Math.max(ys-1,0)},{'x':Math.max(xs-1,0),'y':ys},{'x':xs,'y':ys},{'x':Math.min(xs+1,100),'y':ys},{'x':Math.max(xs-1,0),'y':Math.min(ys+1,100)},{'x':xs,'y':Math.min(ys+1,100)},{'x':Math.min(xs+1,100),'y':Math.min(ys+1,100)}]

        return points
    }
    function Reverser(x,y){
        let xs = Math.floor(x*4)
        let ys = Math.floor(y*(640*4))
        return Math.min(xs+ys,((640*360*4)-4))
    }


	function draw() 
	{
		c.clearRect(0, 0, canvas.width, canvas.height);

		c.fillStyle = "#FF0000";
		f = scene.fluid;
		n = f.numY;
 
		var cellScale = 1.1;

		var h = f.h;

		minP = f.p[0];
		maxP = f.p[0];

		for (var i = 0; i < f.numCells; i++) {
			minP = Math.min(minP, f.p[i]);
			maxP = Math.max(maxP, f.p[i]);
		}

		id = c.getImageData(0,0, canvas.width, canvas.height)

		var color = [255, 255, 255, 255]

		for (var i = 0; i < f.numX; i++) {
			for (var j = 0; j < f.numY; j++) {

				if (scene.showPressure) {
					var p = f.p[i*n + j];
					var s = f.m[i*n + j];
					color = getSciColor(p, minP, maxP);
					if (scene.showSmoke) {
						color[1] = Math.max(0.0, color[1] - 255*s);
						color[2] = Math.max(0.0, color[2] - 255*s);
						color[0] = Math.max(0.0, color[0] - 255*s);
					}
				}
				else if (scene.showSmoke) {
					var s = f.m[i*n + j];
					color[0] = 255*s;
					color[1] = 255*s;
					color[2] = 255*s;
					if (scene.sceneNr == 2)
						color = getSciColor(s, 0.0, 1.0);
				}
				else if (f.s[i*n + j] == 0.0) {
					color[0] = 0;
					color[1] = 0;
					color[2] = 0;
				}

				var x = Math.floor(cX(i * h));
				var y = Math.floor(cY((j+1) * h));
				var cx = Math.floor(cScale * cellScale * h) + 1;
				var cy = Math.floor(cScale * cellScale * h) + 1;

				r = color[0];
				g = color[1];
				b = color[2];

				for (var yi = y; yi < y + cy; yi++) {
					var p = 4 * (yi * canvas.width + x)

					for (var xi = 0; xi < cx; xi++) {
                        
                        // if(pomao.checkInsidePomao({x:Indexer(p)[4].x, y:Indexer(p)[4].y})){
                           
                        //     id.data[p] = 255;
                        //     p++
                        // }else{
                        //     p++
                        // }
						id.data[p++] = r;
						id.data[p++] = g;
						id.data[p++] = b;
						id.data[p++] = 255;
					}
				}
			}
		}

		c.putImageData(id, 0, 0);

		if (scene.showVelocities) {

			c.strokeStyle = "#000000";	
			scale = 0.02;	

			for (var i = 0; i < f.numX; i++) {
				for (var j = 0; j < f.numY; j++) {

					var u = f.u[i*n + j];
					var v = f.v[i*n + j];

					c.beginPath();

					x0 = cX(i * h);
					x1 = cX(i * h + u * scale);
					y = cY((j + 0.5) * h );

					c.moveTo(x0, y);
					c.lineTo(x1, y);
					c.stroke();

					x = cX((i + 0.5) * h);
					y0 = cY(j * h );
					y1 = cY(j * h + v * scale)

					c.beginPath();
					c.moveTo(x, y0);
					c.lineTo(x, y1);
					c.stroke();

				}
			}
		}

		if (scene.showStreamlines) {

			var segLen = f.h * 0.2;
			var numSegs = 15;

			c.strokeStyle = "#000000";

			for (var i = 1; i < f.numX - 1; i += 5) {
				for (var j = 1; j < f.numY - 1; j += 5) {

					var x = (i + 0.5) * f.h;
					var y = (j + 0.5) * f.h;

					c.beginPath();
					c.moveTo(cX(x), cY(y));

					for (var n = 0; n < numSegs; n++) {
						var u = f.sampleField(x, y, U_FIELD);
						var v = f.sampleField(x, y, V_FIELD);
						l = Math.sqrt(u*u + v*v);
						// x += u/l * segLen;
						// y += v/l * segLen;
						x += u * 0.01;
						y += v * 0.01;
						if (x > f.numX * f.h)
							break;

						c.lineTo(cX(x), cY(y));
					}
					c.stroke();
				}
			}
		}

		// if (scene.showObstacle) {

			c.strokeW
			r = scene.obstacleRadius + f.h;
			if (scene.showPressure)
				c.fillStyle = "#333333";
			else
				c.fillStyle = "#333333";
			c.beginPath();	
			c.arc(
				cX(scene.obstacleX), cY(scene.obstacleY), cScale * r, 0.0, 2.0 * Math.PI); 
			c.closePath();
			// c.fill();

			c.lineWidth = 3.0;
			c.strokeStyle = "#333333";
			c.beginPath();	
			c.arc(
				cX(scene.obstacleX), cY(scene.obstacleY), cScale * r, 0.0, 2.0 * Math.PI); 
			c.closePath();
			// c.stroke();
			c.lineWidth = 1.0;
		// }

		if (scene.showPressure) {
			var s = "pressure: " + minP.toFixed(0) + " - " + maxP.toFixed(0) + " N/m";
			c.fillStyle ="#333333";
			c.font = "16px Arial";
			// c.fillText(s, 10, 35);
		}
	}
        const pomaoimg = new Image()
        pomaoimg.src = 'rcpomaolpx2.png'

	function setObstacle(x, y, reset) {

		var vx = 0.0;
		var vy = 0.0;

		if (!reset) {
			vx = (x - scene.obstacleX) / scene.dt;
			vy = (y - scene.obstacleY) / scene.dt;
		}

		scene.obstacleX = x;
		scene.obstacleY = y;
		var r = scene.obstacleRadius;
		var f = scene.fluid;
		var n = f.numY;
		var cd = Math.sqrt(2) * f.h;

		for (var i = 1; i < f.numX-2; i++) {
			for (var j = 1; j < f.numY-2; j++) {

				f.s[i*n + j] = 1.0;

				dx = (i + 0.5) * f.h - x;
				dy = (j + 0.5) * f.h - y;



                //check inside pomao
                if(pomao.checkInsidePomaoPolar({x:i,y:j})){
                    
				// if (dx * dx + dy * dy < r * r) {
					f.s[i*n + j] = 0.0;
					if (scene.sceneNr == 2) {
						f.m[i*n + j] = 0.5 + 0.5 * Math.sin(0.1 * scene.frameNr)
                    }else {
						f.m[i*n + j] = 1.0;
                    }
					f.u[i*n + j] = vx;
					f.u[(i+1)*n + j] = vx;
					f.v[i*n + j] = vy;
					f.v[i*n + j+1] = vy;
				}
				// }
			}
		}
		
		scene.showObstacle = true;
	}

	// interaction -------------------------------------------------------

	var mouseDown = false;

	function startDrag(x, y) {
		let bounds = canvas.getBoundingClientRect();

		let mx = x - bounds.left - canvas.clientLeft;
		let my = y - bounds.top - canvas.clientTop;
		mouseDown = true;

		x = mx / cScale;
		y = (canvas.height - my) / cScale;

		setObstacle(x,y, true);
	}

	function drag(x, y) {
		if (mouseDown) {
			let bounds = canvas.getBoundingClientRect();
			let mx = x - bounds.left - canvas.clientLeft;
			let my = y - bounds.top - canvas.clientTop;
			x = mx / cScale;
			y = (canvas.height - my) / cScale;
			setObstacle(x,y, false);
		}
	}

	function endDrag() {
		mouseDown = false;
	}

	canvas.addEventListener('mousedown', event => {
		startDrag(event.x, event.y);
	});

	canvas.addEventListener('mouseup', event => {
		endDrag();
	});

	canvas.addEventListener('mousemove', event => {
		drag(event.x, event.y);
	});

	canvas.addEventListener('touchstart', event => {
		startDrag(event.touches[0].clientX, event.touches[0].clientY)
	});

	canvas.addEventListener('touchend', event => {
		endDrag()
	});

	canvas.addEventListener('touchmove', event => {
		event.preventDefault();
		event.stopImmediatePropagation();
		drag(event.touches[0].clientX, event.touches[0].clientY)
	}, { passive: false});


	document.addEventListener('keydown', event => {
		switch(event.key) {
			case 'p': scene.paused = !scene.paused; break;
			case 'm': scene.paused = false; simulate(); scene.paused = true; break;
		}
	});

	function toggleStart()
	{
		var button = document.getElementById('startButton');
		if (scene.paused)
			button.innerHTML = "Stop";
		else
			button.innerHTML = "Start";
		scene.paused = !scene.paused;
	}

	// main -------------------------------------------------------

	function simulate() 
	{
		if (!scene.paused)
			scene.fluid.simulate(scene.dt, scene.gravity, scene.numIters)
			scene.frameNr++;
	}

	function update() {
		simulate();
		draw();
		// requestAnimationFrame(update);
	}

    video_recorder = new CanvasCaptureToWEBM(canvas, 4500000);
    window.setInterval(function () {
            update()
            // let rand = 1 + ((Math.random()-.5)/10)
            // rand
            // let rand = .9998
            // if(rand <1){
            // if(scene.obstacleRadius > .01){
            //     scene.obstacleRadius *= rand
            // }
            // }else{
            // // if(scene.obstacleRadius > .26){
            // //     scene.obstacleRadius *= (rand+.01)
            // // }
            // }
        // setObstacle(pomao.body.x, pomao.body.y, false)

        if(keysPressed['-'] && recording == 0){
            recording = 1
            video_recorder.record()
        }
        if((keysPressed['='] || scene.obstacleRadius < .01) && recording == 1){
            recording = 0
            video_recorder.stop()
            video_recorder.download('poflow.webm')
        }

        if(!keysPressed['l']){
            c.drawImage(pomaoimg, 0, 0, pomaoimg.width, pomaoimg.height, pomao.body.x-46, pomao.body.y-36, 70,70)

        }
        }, 300)
	
	setupScene(1);
	update();
        </script>
    </body>
</html>
